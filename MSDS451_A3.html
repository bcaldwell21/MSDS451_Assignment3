<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>71df866eeec14cb486b64f4528e4d105</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell code" data-execution_count="1"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="fkOoN_I7OCFo" data-outputId="faf2052c-dee0-4f0e-94e6-354a0e1d966f">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>initial_cash <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>max_allocation <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>future_window <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>risk_level <span class="op">=</span> <span class="st">&#39;medium&#39;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>ticker <span class="op">=</span> <span class="st">&#39;XOM&#39;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">&#39;2010-01-01&#39;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">&#39;2025-01-01&#39;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> yf.download(ticker, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="2" id="gLEHfnSwOOvt">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;EMA_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">20</span>, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].diff(periods<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;STD_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).std()</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Upper_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lower_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;RSI&#39;</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> (<span class="dv">100</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Close&#39;</span>].diff().clip(lower<span class="op">=</span><span class="dv">0</span>).rolling(<span class="dv">14</span>).mean() <span class="op">/</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                            df[<span class="st">&#39;Close&#39;</span>].diff().clip(upper<span class="op">=</span><span class="dv">0</span>).<span class="bu">abs</span>().rolling(<span class="dv">14</span>).mean()))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>future_window) <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span></code></pre></div>
</div>
<div class="cell code" data-execution_count="3" id="Gw9kGx-EOUUE">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> risk_level <span class="op">==</span> <span class="st">&#39;low&#39;</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    buy_threshold <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.04</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> risk_level <span class="op">==</span> <span class="st">&#39;medium&#39;</span>:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    buy_threshold <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    buy_threshold <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.01</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>conditions <span class="op">=</span> [</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&gt;</span> buy_threshold,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&lt;</span> sell_threshold</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>choices <span class="op">=</span> [<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> np.select(conditions, choices, default<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="6" id="u_aDLuKqOYmK">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_strategy(df):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    portfolio_values <span class="op">=</span> []</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> <span class="bu">int</span>(row[<span class="st">&#39;Signal&#39;</span>].item())</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> row[<span class="st">&#39;Close&#39;</span>].item()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> price <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                shares_to_buy <span class="op">=</span> (cash <span class="op">*</span> max_allocation) <span class="op">//</span> price</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                position <span class="op">=</span> shares_to_buy</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                cash <span class="op">-=</span> shares_to_buy <span class="op">*</span> price</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                shares_to_buy <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> price <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                shares_to_short <span class="op">=</span> (cash <span class="op">*</span> max_allocation) <span class="op">//</span> price</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                position <span class="op">=</span> <span class="op">-</span>shares_to_short</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                cash <span class="op">+=</span> shares_to_short <span class="op">*</span> price</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                shares_to_short <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> position <span class="op">*</span> price</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        portfolio_values.append(cash <span class="op">+</span> position <span class="op">*</span> price)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Portfolio_Value&#39;</span>] <span class="op">=</span> portfolio_values</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_strategy(df)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="7"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:643}"
id="2opEe8WKOplF" data-outputId="9da245e3-90f9-4702-a422-f5567e584061">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> df[<span class="st">&#39;Portfolio_Value&#39;</span>].pct_change().dropna()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sharpe_ratio <span class="op">=</span> np.mean(returns) <span class="op">/</span> np.std(returns) <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Sharpe Ratio:&quot;</span>, <span class="bu">round</span>(sharpe_ratio, <span class="dv">2</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>plt.plot(df[<span class="st">&#39;Date&#39;</span>], df[<span class="st">&#39;Portfolio_Value&#39;</span>], label<span class="op">=</span><span class="st">&#39;Strategy with Options/Short&#39;</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Date&quot;</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Portfolio Value&quot;</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Sharpe Ratio: 4.54
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_400ed23278d04960b8c9a31de447419c/b2f8cb7e72faab2e07f4e9bab5ba4a487a688d43.png" /></p>
</div>
</div>
<div class="cell code" data-execution_count="8"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="O69LTiwRPCCc" data-outputId="94a286d8-b0e4-415a-c478-fb6e2b71b3f8">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LSTM, Dense, Dropout</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.callbacks <span class="im">import</span> EarlyStopping</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>initial_cash <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>max_allocation <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>future_window <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>risk_level <span class="op">=</span> <span class="st">&#39;medium&#39;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>ticker <span class="op">=</span> <span class="st">&#39;XOM&#39;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">&#39;2010-01-01&#39;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">&#39;2025-01-01&#39;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> yf.download(ticker, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="9" id="XSmHjuirPSMv">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;EMA_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">20</span>, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].diff(periods<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;STD_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).std()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Upper_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lower_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;RSI&#39;</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> (<span class="dv">100</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Close&#39;</span>].diff().clip(lower<span class="op">=</span><span class="dv">0</span>).rolling(<span class="dv">14</span>).mean() <span class="op">/</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                            df[<span class="st">&#39;Close&#39;</span>].diff().clip(upper<span class="op">=</span><span class="dv">0</span>).<span class="bu">abs</span>().rolling(<span class="dv">14</span>).mean()))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>future_window) <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_thresholds(risk):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;low&#39;</span>: (<span class="fl">0.04</span>, <span class="op">-</span><span class="fl">0.04</span>),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;medium&#39;</span>: (<span class="fl">0.02</span>, <span class="op">-</span><span class="fl">0.02</span>),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;high&#39;</span>: (<span class="fl">0.01</span>, <span class="op">-</span><span class="fl">0.01</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    }[risk]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>buy_th, sell_th <span class="op">=</span> get_thresholds(risk_level)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> np.select(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    [df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&gt;</span> buy_th, df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&lt;</span> sell_th],</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>], default<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="10" id="9zbQ2_-MPdP6">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[features].copy()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">&#39;Signal&#39;</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>y_remapped <span class="op">=</span> y.<span class="bu">map</span>({<span class="op">-</span><span class="dv">1</span>: <span class="dv">0</span>, <span class="dv">0</span>: <span class="dv">1</span>, <span class="dv">1</span>: <span class="dv">2</span>})</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>ts_split <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>X_scaled <span class="op">=</span> scaler.fit_transform(X)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="13"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="sZM6nmCxPlBC" data-outputId="44a53baf-f37f-4476-80c4-718cb26c78a2">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>train_idx, test_idx <span class="op">=</span> <span class="bu">list</span>(ts_split.split(X_scaled))[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>X_train, X_test <span class="op">=</span> X_scaled[train_idx], X_scaled[test_idx]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>y_train, y_test <span class="op">=</span> y.iloc[train_idx], y.iloc[test_idx]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>rf.fit(X_train, y_train)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>y_pred_rf <span class="op">=</span> rf.predict(X_test)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Random Forest:&quot;</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred_rf))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>X_lstm <span class="op">=</span> []</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>y_lstm <span class="op">=</span> []</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>lookback <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>X_array <span class="op">=</span> X_scaled.copy()</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>y_array <span class="op">=</span> y_remapped.values</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(lookback, <span class="bu">len</span>(X_array)):</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    X_lstm.append(X_array[i<span class="op">-</span>lookback:i])</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    y_lstm.append(y_array[i])</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>X_lstm, y_lstm <span class="op">=</span> np.array(X_lstm), np.array(y_lstm)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>X_train_lstm, X_test_lstm <span class="op">=</span> X_lstm[:<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(X_lstm))], X_lstm[<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(X_lstm)):]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>y_train_lstm, y_test_lstm_remapped <span class="op">=</span> y_lstm[:<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(y_lstm))], y_lstm[<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(y_lstm)):]</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>lstm <span class="op">=</span> Sequential()</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>lstm.add(LSTM(<span class="dv">64</span>, return_sequences<span class="op">=</span><span class="va">False</span>, input_shape<span class="op">=</span>(X_train_lstm.shape[<span class="dv">1</span>], X_train_lstm.shape[<span class="dv">2</span>])))</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>lstm.add(Dropout(<span class="fl">0.2</span>))</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>lstm.add(Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>))</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>lstm.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, loss<span class="op">=</span><span class="st">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>lstm.fit(X_train_lstm, y_train_lstm, epochs<span class="op">=</span><span class="dv">10</span>, batch_size<span class="op">=</span><span class="dv">32</span>, validation_split<span class="op">=</span><span class="fl">0.2</span>, callbacks<span class="op">=</span>[EarlyStopping(patience<span class="op">=</span><span class="dv">3</span>)], verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>lstm_preds_remapped <span class="op">=</span> np.argmax(lstm.predict(X_test_lstm), axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Random Forest:
              precision    recall  f1-score   support

          -1       0.26      0.91      0.41       164
           0       0.80      0.01      0.03       275
           1       0.47      0.13      0.20       186

    accuracy                           0.28       625
   macro avg       0.51      0.35      0.21       625
weighted avg       0.56      0.28      0.18       625

Epoch 1/10
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:199: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>75/75 ━━━━━━━━━━━━━━━━━━━━ 3s 17ms/step - accuracy: 0.5699 - loss: 0.9792 - val_accuracy: 0.4104 - val_loss: 1.1362
Epoch 2/10
75/75 ━━━━━━━━━━━━━━━━━━━━ 1s 14ms/step - accuracy: 0.6290 - loss: 0.8893 - val_accuracy: 0.4054 - val_loss: 1.1278
Epoch 3/10
75/75 ━━━━━━━━━━━━━━━━━━━━ 1s 14ms/step - accuracy: 0.6396 - loss: 0.8679 - val_accuracy: 0.4020 - val_loss: 1.1523
Epoch 4/10
75/75 ━━━━━━━━━━━━━━━━━━━━ 1s 14ms/step - accuracy: 0.6627 - loss: 0.8356 - val_accuracy: 0.4104 - val_loss: 1.1078
Epoch 5/10
75/75 ━━━━━━━━━━━━━━━━━━━━ 2s 23ms/step - accuracy: 0.6297 - loss: 0.8696 - val_accuracy: 0.3953 - val_loss: 1.1352
Epoch 6/10
75/75 ━━━━━━━━━━━━━━━━━━━━ 1s 16ms/step - accuracy: 0.6129 - loss: 0.8797 - val_accuracy: 0.4087 - val_loss: 1.1467
Epoch 7/10
75/75 ━━━━━━━━━━━━━━━━━━━━ 1s 12ms/step - accuracy: 0.6311 - loss: 0.8788 - val_accuracy: 0.4087 - val_loss: 1.1308
24/24 ━━━━━━━━━━━━━━━━━━━━ 0s 11ms/step
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="14"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="C8266te5PyQA" data-outputId="fa1d2b93-8730-4c62-f3d2-e61b79975bb7">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>remap_back <span class="op">=</span> {<span class="dv">0</span>: <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>: <span class="dv">0</span>, <span class="dv">2</span>: <span class="dv">1</span>}</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>lstm_preds <span class="op">=</span> np.array([remap_back[pred] <span class="cf">for</span> pred <span class="kw">in</span> lstm_preds_remapped])</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>y_test_lstm <span class="op">=</span> np.array([remap_back[label] <span class="cf">for</span> label <span class="kw">in</span> y_test_lstm_remapped])</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">LSTM:&quot;</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test_lstm, lstm_preds))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
LSTM:
              precision    recall  f1-score   support

          -1       0.06      0.01      0.01       195
           0       0.41      0.97      0.58       308
           1       0.00      0.00      0.00       243

    accuracy                           0.40       746
   macro avg       0.16      0.33      0.20       746
weighted avg       0.18      0.40      0.24       746

</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1565: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="15"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="nZ_s8yvuP-MP" data-outputId="bac16b3f-d7de-4828-c56c-b6c2d7795bc3">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> LSTM, Dense, Input</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> to_categorical</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>initial_cash <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>max_allocation <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>future_window <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>ticker <span class="op">=</span> <span class="st">&#39;XOM&#39;</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">&#39;2010-01-01&#39;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">&#39;2025-01-01&#39;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> yf.download(ticker, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date, auto_adjust<span class="op">=</span><span class="va">True</span>).reset_index()</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(<span class="dv">10</span>).mean()</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;EMA_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">20</span>).mean()</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].diff(<span class="dv">10</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;STD_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(<span class="dv">20</span>).std()</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Upper_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lower_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;RSI&#39;</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> (<span class="dv">100</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Close&#39;</span>].diff().clip(lower<span class="op">=</span><span class="dv">0</span>).rolling(<span class="dv">14</span>).mean() <span class="op">/</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>                            df[<span class="st">&#39;Close&#39;</span>].diff().clip(upper<span class="op">=</span><span class="dv">0</span>).<span class="bu">abs</span>().rolling(<span class="dv">14</span>).mean()))</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;MACD&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">12</span>).mean() <span class="op">-</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">26</span>).mean()</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>high_low <span class="op">=</span> df[<span class="st">&#39;High&#39;</span>] <span class="op">-</span> df[<span class="st">&#39;Low&#39;</span>]</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>high_prev_close <span class="op">=</span> <span class="bu">abs</span>(df[<span class="st">&#39;High&#39;</span>] <span class="op">-</span> df[<span class="st">&#39;Close&#39;</span>].shift())</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>low_prev_close <span class="op">=</span> <span class="bu">abs</span>(df[<span class="st">&#39;Low&#39;</span>] <span class="op">-</span> df[<span class="st">&#39;Close&#39;</span>].shift())</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;TR&#39;</span>] <span class="op">=</span> pd.concat([high_low, high_prev_close, low_prev_close], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;ATR&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;TR&#39;</span>].rolling(window<span class="op">=</span><span class="dv">14</span>).mean()</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lag_1&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="dv">1</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lag_2&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="dv">2</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lag_3&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="dv">3</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lag_5&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="dv">5</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>future_window) <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;Future_Return&#39;</span>].quantile(<span class="fl">0.7</span>), <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&lt;</span> df[<span class="st">&#39;Future_Return&#39;</span>].quantile(<span class="fl">0.3</span>), <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;RSI&#39;</span>, <span class="st">&#39;MACD&#39;</span>, <span class="st">&#39;ATR&#39;</span>, <span class="st">&#39;Lag_1&#39;</span>, <span class="st">&#39;Lag_2&#39;</span>, <span class="st">&#39;Lag_3&#39;</span>, <span class="st">&#39;Lag_5&#39;</span>]</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[features]</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">&#39;Signal&#39;</span>]</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>X_scaled <span class="op">=</span> scaler.fit_transform(X)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="16"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="cdFoH1rmQM7K" data-outputId="f33a4f7f-ad60-4589-fd02-648a7fc4b723">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>X_train_rf, X_test_rf, y_train_rf, y_test_rf <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>rf_model <span class="op">=</span> RandomForestClassifier(class_weight<span class="op">=</span><span class="st">&#39;balanced&#39;</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>rf_model.fit(X_train_rf, y_train_rf)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>rf_preds <span class="op">=</span> rf_model.predict(X_test_rf)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Random Forest:</span><span class="ch">\n</span><span class="st">&quot;</span>, classification_report(y_test_rf, rf_preds))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>y_remapped <span class="op">=</span> y.<span class="bu">map</span>({<span class="op">-</span><span class="dv">1</span>: <span class="dv">0</span>, <span class="dv">0</span>: <span class="dv">1</span>, <span class="dv">1</span>: <span class="dv">2</span>})</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>y_array <span class="op">=</span> y_remapped.values</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>X_lstm <span class="op">=</span> []</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>y_lstm <span class="op">=</span> []</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>lookback <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>X_array <span class="op">=</span> X_scaled.copy()</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(lookback, <span class="bu">len</span>(X_array)):</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    X_lstm.append(X_array[i<span class="op">-</span>lookback:i])</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    y_lstm.append(y_array[i])</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>X_lstm, y_lstm <span class="op">=</span> np.array(X_lstm), np.array(y_lstm)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(X_lstm) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Not enough data after lookback for train/test split&quot;</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    X_train_lstm, X_test_lstm, y_train_lstm, y_test_lstm_remapped <span class="op">=</span> train_test_split(X_lstm, y_lstm, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    lstm_model <span class="op">=</span> Sequential([</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        Input(shape<span class="op">=</span>(X_train_lstm.shape[<span class="dv">1</span>], X_train_lstm.shape[<span class="dv">2</span>])),</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        LSTM(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    lstm_model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, loss<span class="op">=</span><span class="st">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    lstm_model.fit(X_train_lstm, y_train_lstm, epochs<span class="op">=</span><span class="dv">10</span>, batch_size<span class="op">=</span><span class="dv">32</span>, validation_data<span class="op">=</span>(X_test_lstm, y_test_lstm_remapped), verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    lstm_preds_remapped <span class="op">=</span> np.argmax(lstm_model.predict(X_test_lstm), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    remap_back <span class="op">=</span> {<span class="dv">0</span>: <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>: <span class="dv">0</span>, <span class="dv">2</span>: <span class="dv">1</span>}</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    lstm_preds <span class="op">=</span> np.array([remap_back[pred] <span class="cf">for</span> pred <span class="kw">in</span> lstm_preds_remapped])</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    y_test_lstm <span class="op">=</span> np.array([remap_back[label] <span class="cf">for</span> label <span class="kw">in</span> y_test_lstm_remapped])</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">LSTM:&quot;</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(classification_report(y_test_lstm, lstm_preds))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Random Forest:
               precision    recall  f1-score   support

          -1       0.65      0.59      0.62       224
           0       0.59      0.65      0.62       304
           1       0.64      0.62      0.63       222

    accuracy                           0.62       750
   macro avg       0.63      0.62      0.62       750
weighted avg       0.62      0.62      0.62       750

Epoch 1/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 3s 15ms/step - accuracy: 0.4038 - loss: 1.0851 - val_accuracy: 0.4357 - val_loss: 1.0612
Epoch 2/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 2s 13ms/step - accuracy: 0.4515 - loss: 1.0598 - val_accuracy: 0.4598 - val_loss: 1.0595
Epoch 3/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 3s 20ms/step - accuracy: 0.4339 - loss: 1.0564 - val_accuracy: 0.4906 - val_loss: 1.0342
Epoch 4/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 12ms/step - accuracy: 0.4811 - loss: 1.0411 - val_accuracy: 0.5000 - val_loss: 1.0302
Epoch 5/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 12ms/step - accuracy: 0.4633 - loss: 1.0431 - val_accuracy: 0.4946 - val_loss: 1.0294
Epoch 6/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 12ms/step - accuracy: 0.4842 - loss: 1.0256 - val_accuracy: 0.4772 - val_loss: 1.0211
Epoch 7/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 14ms/step - accuracy: 0.4840 - loss: 1.0225 - val_accuracy: 0.5040 - val_loss: 1.0185
Epoch 8/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 3s 14ms/step - accuracy: 0.4808 - loss: 1.0176 - val_accuracy: 0.4960 - val_loss: 1.0206
Epoch 9/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 3s 14ms/step - accuracy: 0.4979 - loss: 1.0130 - val_accuracy: 0.4920 - val_loss: 1.0193
Epoch 10/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 2s 22ms/step - accuracy: 0.4899 - loss: 1.0092 - val_accuracy: 0.4866 - val_loss: 1.0178
24/24 ━━━━━━━━━━━━━━━━━━━━ 0s 11ms/step

LSTM:
              precision    recall  f1-score   support

          -1       0.42      0.27      0.33       227
           0       0.48      0.81      0.60       290
           1       0.63      0.29      0.40       229

    accuracy                           0.49       746
   macro avg       0.51      0.46      0.44       746
weighted avg       0.50      0.49      0.46       746

</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="17" id="hWoZev8KQhIN">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential, load_model</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LSTM, Dense, Dropout, Bidirectional</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> to_categorical</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> engineer_features(df):</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;EMA_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">20</span>, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].diff(periods<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;STD_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).std()</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Upper_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Lower_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;RSI&#39;</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> (<span class="dv">100</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Close&#39;</span>].diff().clip(lower<span class="op">=</span><span class="dv">0</span>).rolling(<span class="dv">14</span>).mean() <span class="op">/</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                                df[<span class="st">&#39;Close&#39;</span>].diff().clip(upper<span class="op">=</span><span class="dv">0</span>).<span class="bu">abs</span>().rolling(<span class="dv">14</span>).mean()))</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_signals(df, future_window<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>future_window) <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&gt;</span> <span class="fl">0.02</span>, <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>, <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_lstm_model(df):</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> to_categorical(df[<span class="st">&#39;Signal&#39;</span>] <span class="op">+</span> <span class="dv">1</span>, num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> X_scaled.reshape((X_scaled.shape[<span class="dv">0</span>], <span class="dv">1</span>, X_scaled.shape[<span class="dv">1</span>]))</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        Bidirectional(LSTM(<span class="dv">64</span>, return_sequences<span class="op">=</span><span class="va">True</span>), input_shape<span class="op">=</span>(<span class="dv">1</span>, X_scaled.shape[<span class="dv">2</span>])),</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.3</span>),</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>        LSTM(<span class="dv">32</span>),</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">16</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.2</span>),</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>, optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train, epochs<span class="op">=</span><span class="dv">10</span>, validation_data<span class="op">=</span>(X_val, y_val), batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    model.save(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    joblib.dump(scaler, <span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;LSTM model and scaler saved&quot;</span>)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_rf_model(df):</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">&#39;Signal&#39;</span>].values</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>    clf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">200</span>, max_depth<span class="op">=</span><span class="dv">8</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    clf.fit(X_train, y_train)</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> clf.predict(X_val)</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Random Forest:&quot;</span>)</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(classification_report(y_val, y_pred))</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    joblib.dump(clf, <span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>    joblib.dump(scaler, <span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Random Forest model and scaler saved&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="18" id="ZcyllC_EQ3FI">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_signal_from_yfinance(ticker<span class="op">=</span><span class="st">&#39;XOM&#39;</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> yf.download(ticker, period<span class="op">=</span><span class="st">&#39;6mo&#39;</span>, interval<span class="op">=</span><span class="st">&#39;1d&#39;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> engineer_features(df)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values[<span class="op">-</span><span class="dv">1</span>:]</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    lstm_model <span class="op">=</span> load_model(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    lstm_scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    X_lstm <span class="op">=</span> lstm_scaler.transform(X).reshape((<span class="dv">1</span>, <span class="dv">1</span>, X.shape[<span class="dv">1</span>]))</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    lstm_pred <span class="op">=</span> np.argmax(lstm_model.predict(X_lstm), axis<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> joblib.load(<span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    rf_scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    X_rf <span class="op">=</span> rf_scaler.transform(X)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    rf_pred <span class="op">=</span> rf_model.predict(X_rf)[<span class="dv">0</span>]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;LSTM Prediction: </span><span class="sc">{</span>lstm_pred<span class="sc">}</span><span class="ss">, RF Prediction: </span><span class="sc">{</span>rf_pred<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;LSTM&quot;</span>: lstm_pred, <span class="st">&quot;RF&quot;</span>: rf_pred}</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="19"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="0ofua3f1RBe9" data-outputId="25c74307-446d-4a18-e30d-c95513baf934">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">&quot;lstm_model.h5&quot;</span>) <span class="kw">or</span> <span class="kw">not</span> os.path.exists(<span class="st">&quot;rf_model.pkl&quot;</span>):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> yf.download(<span class="st">&quot;XOM&quot;</span>, start<span class="op">=</span><span class="st">&quot;2010-01-01&quot;</span>, end<span class="op">=</span><span class="st">&quot;2025-01-01&quot;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> engineer_features(df)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> label_signals(df)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    train_lstm_model(df)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    train_rf_model(df)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>predict_signal_from_yfinance(<span class="st">&quot;XOM&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/bidirectional.py:107: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Epoch 1/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 7s 14ms/step - accuracy: 0.5241 - loss: 1.0727 - val_accuracy: 0.5667 - val_loss: 0.9749
Epoch 2/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 7ms/step - accuracy: 0.5598 - loss: 0.9738 - val_accuracy: 0.5560 - val_loss: 0.9613
Epoch 3/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 2s 11ms/step - accuracy: 0.5554 - loss: 0.9690 - val_accuracy: 0.5627 - val_loss: 0.9584
Epoch 4/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 8ms/step - accuracy: 0.5542 - loss: 0.9631 - val_accuracy: 0.5613 - val_loss: 0.9582
Epoch 5/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 8ms/step - accuracy: 0.5674 - loss: 0.9547 - val_accuracy: 0.5680 - val_loss: 0.9564
Epoch 6/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 7ms/step - accuracy: 0.5469 - loss: 0.9785 - val_accuracy: 0.5693 - val_loss: 0.9554
Epoch 7/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 8ms/step - accuracy: 0.5581 - loss: 0.9581 - val_accuracy: 0.5680 - val_loss: 0.9534
Epoch 8/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 7ms/step - accuracy: 0.5559 - loss: 0.9656 - val_accuracy: 0.5653 - val_loss: 0.9531
Epoch 9/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 2s 10ms/step - accuracy: 0.5695 - loss: 0.9500 - val_accuracy: 0.5680 - val_loss: 0.9531
Epoch 10/10
94/94 ━━━━━━━━━━━━━━━━━━━━ 1s 8ms/step - accuracy: 0.5740 - loss: 0.9448 - val_accuracy: 0.5680 - val_loss: 0.9519
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>LSTM model and scaler saved
Random Forest:
              precision    recall  f1-score   support

          -1       0.70      0.18      0.29       154
           0       0.62      0.92      0.74       423
           1       0.61      0.30      0.40       173

    accuracy                           0.63       750
   macro avg       0.65      0.47      0.48       750
weighted avg       0.64      0.63      0.57       750

Random Forest model and scaler saved
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>1/1 ━━━━━━━━━━━━━━━━━━━━ 0s 470ms/step
LSTM Prediction: 0, RF Prediction: 0
</code></pre>
</div>
<div class="output execute_result" data-execution_count="19">
<pre><code>{&#39;LSTM&#39;: np.int64(0), &#39;RF&#39;: np.int64(0)}</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="21"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="9alghaxYRPB4" data-outputId="781f9337-d62e-4d18-b130-5c6a5e59b286">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential, load_model</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LSTM, Dense, Dropout, Bidirectional</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> to_categorical</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> engineer_features(df):</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;EMA_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">20</span>, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].diff(periods<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;STD_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).std()</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Upper_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Lower_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;RSI&#39;</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> (<span class="dv">100</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Close&#39;</span>].diff().clip(lower<span class="op">=</span><span class="dv">0</span>).rolling(<span class="dv">14</span>).mean() <span class="op">/</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>                                df[<span class="st">&#39;Close&#39;</span>].diff().clip(upper<span class="op">=</span><span class="dv">0</span>).<span class="bu">abs</span>().rolling(<span class="dv">14</span>).mean()))</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_signals(df, future_window<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>future_window) <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&gt;</span> <span class="fl">0.02</span>, <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>, <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_lstm_model(df):</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> to_categorical(df[<span class="st">&#39;Signal&#39;</span>] <span class="op">+</span> <span class="dv">1</span>, num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> X_scaled.reshape((X_scaled.shape[<span class="dv">0</span>], <span class="dv">1</span>, X_scaled.shape[<span class="dv">1</span>]))</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>        Bidirectional(LSTM(<span class="dv">64</span>, return_sequences<span class="op">=</span><span class="va">True</span>), input_shape<span class="op">=</span>(<span class="dv">1</span>, X_scaled.shape[<span class="dv">2</span>])),</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.3</span>),</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>        LSTM(<span class="dv">32</span>),</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">16</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.2</span>),</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>, optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train, epochs<span class="op">=</span><span class="dv">10</span>, validation_data<span class="op">=</span>(X_val, y_val), batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    model.save(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    joblib.dump(scaler, <span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;LSTM model and scaler saved&quot;</span>)</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_rf_model(df):</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">&#39;Signal&#39;</span>].values</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>    clf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">200</span>, max_depth<span class="op">=</span><span class="dv">8</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>    clf.fit(X_train, y_train)</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> clf.predict(X_val)</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Random Forest:&quot;</span>)</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(classification_report(y_val, y_pred))</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>    joblib.dump(clf, <span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>    joblib.dump(scaler, <span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Random Forest model and scaler saved&quot;</span>)</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_signal_from_yfinance(ticker<span class="op">=</span><span class="st">&#39;XOM&#39;</span>):</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> yf.download(ticker, period<span class="op">=</span><span class="st">&#39;6mo&#39;</span>, interval<span class="op">=</span><span class="st">&#39;1d&#39;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> engineer_features(df)</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values[<span class="op">-</span><span class="dv">1</span>:]</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>    lstm_model <span class="op">=</span> load_model(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>    lstm_scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>    X_lstm <span class="op">=</span> lstm_scaler.transform(X).reshape((<span class="dv">1</span>, <span class="dv">1</span>, X.shape[<span class="dv">1</span>]))</span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>    lstm_pred <span class="op">=</span> np.argmax(lstm_model.predict(X_lstm), axis<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> joblib.load(<span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>    rf_scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>    X_rf <span class="op">=</span> rf_scaler.transform(X)</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>    rf_pred <span class="op">=</span> rf_model.predict(X_rf)[<span class="dv">0</span>]</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;LSTM Prediction: </span><span class="sc">{</span>lstm_pred<span class="sc">}</span><span class="ss">, RF Prediction: </span><span class="sc">{</span>rf_pred<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;LSTM&quot;</span>: lstm_pred, <span class="st">&quot;RF&quot;</span>: rf_pred}</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_model_predictions(df, model_type<span class="op">=</span><span class="st">&#39;rf&#39;</span>):</span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>    initial_cash <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>    portfolio <span class="op">=</span> []</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>    model_type <span class="op">=</span> model_type.lower()</span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_type <span class="op">==</span> <span class="st">&#39;lstm&#39;</span>:</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> load_model(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>        scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>        X_scaled <span class="op">=</span> scaler.transform(X).reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, X.shape[<span class="dv">1</span>]))</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> np.argmax(model.predict(X_scaled), axis<span class="op">=</span><span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_type <span class="op">==</span> <span class="st">&#39;rf&#39;</span>:</span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> joblib.load(<span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>        scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>        X_scaled <span class="op">=</span> scaler.transform(X)</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> model.predict(X_scaled)</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Unknown model_type: </span><span class="sc">{</span>model_type<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> preds.tolist()</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(df)):</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> <span class="bu">int</span>(preds[i])</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> <span class="bu">float</span>(df[<span class="st">&#39;Close&#39;</span>].iloc[i])</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>((cash <span class="op">*</span> <span class="fl">0.8</span>) <span class="op">//</span> price)</span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> shares <span class="op">*</span> price</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> shares</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>((cash <span class="op">*</span> <span class="fl">0.8</span>) <span class="op">//</span> price)</span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> shares <span class="op">*</span> price</span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="op">-</span>shares</span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> position <span class="op">*</span> price</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>        portfolio.append(cash <span class="op">+</span> position <span class="op">*</span> price)</span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f&#39;</span><span class="sc">{</span>model_type<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">_Portfolio&#39;</span>] <span class="op">=</span> portfolio</span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_with_options(df, signal_col, initial_cash<span class="op">=</span><span class="dv">10000</span>, max_allocation<span class="op">=</span><span class="fl">0.8</span>, risk_level<span class="op">=</span><span class="st">&#39;medium&#39;</span>):</span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> risk_level <span class="op">==</span> <span class="st">&#39;low&#39;</span>:</span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.04</span></span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> risk_level <span class="op">==</span> <span class="st">&#39;high&#39;</span>:</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.01</span></span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a>    portfolio_values <span class="op">=</span> []</span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> <span class="bu">int</span>(row[signal_col].item())</span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> row[<span class="st">&#39;Close&#39;</span>].item()</span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> (cash <span class="op">*</span> max_allocation) <span class="op">//</span> price</span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> shares <span class="op">*</span> price</span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> shares</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> (cash <span class="op">*</span> max_allocation) <span class="op">//</span> price</span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> shares <span class="op">*</span> price</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="op">-</span>shares</span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> position <span class="op">*</span> price</span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>        portfolio_values.append(cash <span class="op">+</span> position <span class="op">*</span> price)</span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f&#39;</span><span class="sc">{</span>signal_col<span class="sc">}</span><span class="ss">_Options_Portfolio&#39;</span>] <span class="op">=</span> portfolio_values</span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">&quot;lstm_model.h5&quot;</span>) <span class="kw">or</span> <span class="kw">not</span> os.path.exists(<span class="st">&quot;rf_model.pkl&quot;</span>):</span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> yf.download(<span class="st">&quot;XOM&quot;</span>, start<span class="op">=</span><span class="st">&quot;2010-01-01&quot;</span>, end<span class="op">=</span><span class="st">&quot;2025-01-01&quot;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> engineer_features(df)</span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> label_signals(df)</span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a>    train_lstm_model(df)</span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a>    train_rf_model(df)</span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a>predict_signal_from_yfinance(<span class="st">&quot;XOM&quot;</span>)</span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> yf.download(<span class="st">&quot;XOM&quot;</span>, start<span class="op">=</span><span class="st">&quot;2010-01-01&quot;</span>, end<span class="op">=</span><span class="st">&quot;2025-01-01&quot;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a>df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> engineer_features(df)</span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> label_signals(df)</span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_model_predictions(df, model_type<span class="op">=</span><span class="st">&#39;rf&#39;</span>)</span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_model_predictions(df, model_type<span class="op">=</span><span class="st">&#39;lstm&#39;</span>)</span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_with_options(df, signal_col<span class="op">=</span><span class="st">&#39;Signal&#39;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>1/1 ━━━━━━━━━━━━━━━━━━━━ 0s 457ms/step
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
<div class="output stream stdout">
<pre><code>LSTM Prediction: 0, RF Prediction: 0
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
/tmp/ipython-input-2545116281.py:131: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  price = float(df[&#39;Close&#39;].iloc[i])
WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>118/118 ━━━━━━━━━━━━━━━━━━━━ 1s 6ms/step
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/tmp/ipython-input-2545116281.py:131: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  price = float(df[&#39;Close&#39;].iloc[i])
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="22"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="0KBLwvO1SDdL" data-outputId="cd2cc37d-4304-496c-b3b3-468368b258d4">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_performance_metrics(df, value_col, risk_free_rate<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> df[value_col].pct_change().dropna()</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    cumulative_return <span class="op">=</span> df[value_col].iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">/</span> df[value_col].iloc[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    annualized_return <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> cumulative_return) <span class="op">**</span> (<span class="dv">252</span> <span class="op">/</span> <span class="bu">len</span>(df)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    annualized_volatility <span class="op">=</span> returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio <span class="op">=</span> (annualized_return <span class="op">-</span> risk_free_rate) <span class="op">/</span> annualized_volatility <span class="cf">if</span> annualized_volatility <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    rolling_max <span class="op">=</span> df[value_col].cummax()</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> df[value_col] <span class="op">/</span> rolling_max <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    max_drawdown <span class="op">=</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Cumulative Return&#39;</span>: cumulative_return,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Annualized Return&#39;</span>: annualized_return,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Annualized Volatility&#39;</span>: annualized_volatility,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Sharpe Ratio&#39;</span>: sharpe_ratio,</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Max Drawdown&#39;</span>: max_drawdown</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">&#39;RF_Portfolio&#39;</span>, <span class="st">&#39;LSTM_Portfolio&#39;</span>, <span class="st">&#39;Signal_Options_Portfolio&#39;</span>]</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>perf_table <span class="op">=</span> {}</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> cols:</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    perf_table[col] <span class="op">=</span> compute_performance_metrics(df, col)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;BuyHold&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>].iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">10000</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>perf_table[<span class="st">&#39;BuyHold&#39;</span>] <span class="op">=</span> compute_performance_metrics(df, <span class="st">&#39;BuyHold&#39;</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>perf_df <span class="op">=</span> pd.DataFrame(perf_table).T</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Strategy Performance Summary:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(perf_df.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Strategy Performance Summary:

                          Cumulative Return  Annualized Return  \
RF_Portfolio                        37.5285             0.2781   
LSTM_Portfolio                      -0.1007            -0.0071   
Signal_Options_Portfolio         26593.9084             0.9831   
BuyHold                              1.8282             0.0724   

                          Annualized Volatility  Sharpe Ratio  Max Drawdown  
RF_Portfolio                             0.1384        1.9372       -0.3378  
LSTM_Portfolio                           0.0975       -0.1755       -0.3606  
Signal_Options_Portfolio                 0.1538        6.3285       -0.1299  
BuyHold                                  0.2501        0.2494       -0.6240  
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="56"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="3033c112" data-outputId="890e2fd4-5813-437d-e6e1-fdfc33cb91f3">
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential, load_model</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LSTM, Dense, Dropout, Bidirectional</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> to_categorical</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> engineer_features(df):</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;EMA_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].ewm(span<span class="op">=</span><span class="dv">20</span>, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].diff(periods<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;STD_20&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).std()</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Upper_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Lower_BB&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;SMA_10&#39;</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> df[<span class="st">&#39;STD_20&#39;</span>]</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;RSI&#39;</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> (<span class="dv">100</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Close&#39;</span>].diff().clip(lower<span class="op">=</span><span class="dv">0</span>).rolling(<span class="dv">14</span>).mean() <span class="op">/</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>                                df[<span class="st">&#39;Close&#39;</span>].diff().clip(upper<span class="op">=</span><span class="dv">0</span>).<span class="bu">abs</span>().rolling(<span class="dv">14</span>).mean()))</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_signals(df, future_window<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>future_window) <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&gt;</span> <span class="fl">0.02</span>, <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">&#39;Future_Return&#39;</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>, <span class="st">&#39;Signal&#39;</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_lstm_model(df):</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> to_categorical(df[<span class="st">&#39;Signal&#39;</span>] <span class="op">+</span> <span class="dv">1</span>, num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> X_scaled.reshape((X_scaled.shape[<span class="dv">0</span>], <span class="dv">1</span>, X_scaled.shape[<span class="dv">1</span>]))</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>        Bidirectional(LSTM(<span class="dv">64</span>, return_sequences<span class="op">=</span><span class="va">True</span>), input_shape<span class="op">=</span>(<span class="dv">1</span>, X_scaled.shape[<span class="dv">2</span>])),</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.3</span>),</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>        LSTM(<span class="dv">32</span>),</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">16</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.2</span>),</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>, optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train, epochs<span class="op">=</span><span class="dv">10</span>, validation_data<span class="op">=</span>(X_val, y_val), batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    model.save(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>    joblib.dump(scaler, <span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;LSTM model and scaler saved&quot;</span>)</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_rf_model(df):</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">&#39;Signal&#39;</span>].values</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(X_scaled, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>    clf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">200</span>, max_depth<span class="op">=</span><span class="dv">8</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>    clf.fit(X_train, y_train)</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> clf.predict(X_val)</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Random Forest:&quot;</span>)</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(classification_report(y_val, y_pred))</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>    joblib.dump(clf, <span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>    joblib.dump(scaler, <span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Random Forest model and scaler saved&quot;</span>)</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_signal_from_yfinance(ticker<span class="op">=</span><span class="st">&#39;XOM&#39;</span>):</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> yf.download(ticker, period<span class="op">=</span><span class="st">&#39;6mo&#39;</span>, interval<span class="op">=</span><span class="st">&#39;1d&#39;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> engineer_features(df)</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values[<span class="op">-</span><span class="dv">1</span>:]</span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>    lstm_model <span class="op">=</span> load_model(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>    lstm_scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>    X_lstm <span class="op">=</span> lstm_scaler.transform(X).reshape((<span class="dv">1</span>, <span class="dv">1</span>, X.shape[<span class="dv">1</span>]))</span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>    lstm_pred <span class="op">=</span> np.argmax(lstm_model.predict(X_lstm), axis<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> joblib.load(<span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>    rf_scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>    X_rf <span class="op">=</span> rf_scaler.transform(X)</span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a>    rf_pred <span class="op">=</span> rf_model.predict(X_rf)[<span class="dv">0</span>]</span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;LSTM Prediction: </span><span class="sc">{</span>lstm_pred<span class="sc">}</span><span class="ss">, RF Prediction: </span><span class="sc">{</span>rf_pred<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;LSTM&quot;</span>: lstm_pred, <span class="st">&quot;RF&quot;</span>: rf_pred}</span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_model_predictions(df, model_type<span class="op">=</span><span class="st">&#39;rf&#39;</span>):</span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">&#39;SMA_10&#39;</span>, <span class="st">&#39;EMA_20&#39;</span>, <span class="st">&#39;Momentum&#39;</span>, <span class="st">&#39;STD_20&#39;</span>, <span class="st">&#39;Upper_BB&#39;</span>, <span class="st">&#39;Lower_BB&#39;</span>, <span class="st">&#39;RSI&#39;</span>]</span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>    initial_cash <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>    portfolio <span class="op">=</span> []</span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>    model_type <span class="op">=</span> model_type.lower()</span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[features].values</span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_type <span class="op">==</span> <span class="st">&#39;lstm&#39;</span>:</span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> load_model(<span class="st">&quot;lstm_model.h5&quot;</span>)</span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>        scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_lstm.pkl&quot;</span>)</span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>        X_scaled <span class="op">=</span> scaler.transform(X).reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, X.shape[<span class="dv">1</span>]))</span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> np.argmax(model.predict(X_scaled), axis<span class="op">=</span><span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_type <span class="op">==</span> <span class="st">&#39;rf&#39;</span>:</span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> joblib.load(<span class="st">&quot;rf_model.pkl&quot;</span>)</span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>        scaler <span class="op">=</span> joblib.load(<span class="st">&quot;scaler_rf.pkl&quot;</span>)</span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>        X_scaled <span class="op">=</span> scaler.transform(X)</span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> model.predict(X_scaled)</span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Unknown model_type: </span><span class="sc">{</span>model_type<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> preds.tolist()</span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(df)):</span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> <span class="bu">int</span>(preds[i])</span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> <span class="bu">float</span>(df[<span class="st">&#39;Close&#39;</span>].iloc[i])</span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>((cash <span class="op">*</span> <span class="fl">0.8</span>) <span class="op">//</span> price)</span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> shares <span class="op">*</span> price</span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> shares</span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>((cash <span class="op">*</span> <span class="fl">0.8</span>) <span class="op">//</span> price)</span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> shares <span class="op">*</span> price</span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="op">-</span>shares</span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> position <span class="op">*</span> price</span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a>        portfolio.append(cash <span class="op">+</span> position <span class="op">*</span> price)</span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f&#39;</span><span class="sc">{</span>model_type<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">_Portfolio&#39;</span>] <span class="op">=</span> portfolio</span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb43-149"><a href="#cb43-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-150"><a href="#cb43-150" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_with_options(df, signal_col, initial_cash<span class="op">=</span><span class="dv">10000</span>, max_allocation<span class="op">=</span><span class="fl">0.8</span>, risk_level<span class="op">=</span><span class="st">&#39;medium&#39;</span>):</span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> risk_level <span class="op">==</span> <span class="st">&#39;low&#39;</span>:</span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.04</span></span>
<span id="cb43-154"><a href="#cb43-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> risk_level <span class="op">==</span> <span class="st">&#39;high&#39;</span>:</span>
<span id="cb43-155"><a href="#cb43-155" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb43-156"><a href="#cb43-156" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.01</span></span>
<span id="cb43-157"><a href="#cb43-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb43-158"><a href="#cb43-158" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb43-159"><a href="#cb43-159" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span></span>
<span id="cb43-160"><a href="#cb43-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-161"><a href="#cb43-161" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb43-162"><a href="#cb43-162" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-163"><a href="#cb43-163" aria-hidden="true" tabindex="-1"></a>    portfolio_values <span class="op">=</span> []</span>
<span id="cb43-164"><a href="#cb43-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-165"><a href="#cb43-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb43-166"><a href="#cb43-166" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> <span class="bu">int</span>(row[signal_col].item())</span>
<span id="cb43-167"><a href="#cb43-167" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> row[<span class="st">&#39;Close&#39;</span>].item()</span>
<span id="cb43-168"><a href="#cb43-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-169"><a href="#cb43-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-170"><a href="#cb43-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb43-171"><a href="#cb43-171" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> (cash <span class="op">*</span> max_allocation) <span class="op">//</span> price</span>
<span id="cb43-172"><a href="#cb43-172" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> shares <span class="op">*</span> price</span>
<span id="cb43-173"><a href="#cb43-173" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> shares</span>
<span id="cb43-174"><a href="#cb43-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-175"><a href="#cb43-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb43-176"><a href="#cb43-176" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> (cash <span class="op">*</span> max_allocation) <span class="op">//</span> price</span>
<span id="cb43-177"><a href="#cb43-177" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> shares <span class="op">*</span> price</span>
<span id="cb43-178"><a href="#cb43-178" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="op">-</span>shares</span>
<span id="cb43-179"><a href="#cb43-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-180"><a href="#cb43-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb43-181"><a href="#cb43-181" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> position <span class="op">*</span> price</span>
<span id="cb43-182"><a href="#cb43-182" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-183"><a href="#cb43-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-184"><a href="#cb43-184" aria-hidden="true" tabindex="-1"></a>        portfolio_values.append(cash <span class="op">+</span> position <span class="op">*</span> price)</span>
<span id="cb43-185"><a href="#cb43-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-186"><a href="#cb43-186" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f&#39;</span><span class="sc">{</span>signal_col<span class="sc">}</span><span class="ss">_Options_Portfolio&#39;</span>] <span class="op">=</span> portfolio_values</span>
<span id="cb43-187"><a href="#cb43-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb43-188"><a href="#cb43-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-189"><a href="#cb43-189" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_with_options_realistic(</span>
<span id="cb43-190"><a href="#cb43-190" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb43-191"><a href="#cb43-191" aria-hidden="true" tabindex="-1"></a>    signal_col<span class="op">=</span><span class="st">&#39;Signal&#39;</span>,</span>
<span id="cb43-192"><a href="#cb43-192" aria-hidden="true" tabindex="-1"></a>    initial_cash<span class="op">=</span><span class="dv">10000</span>,</span>
<span id="cb43-193"><a href="#cb43-193" aria-hidden="true" tabindex="-1"></a>    max_leverage<span class="op">=</span><span class="fl">3.0</span>,</span>
<span id="cb43-194"><a href="#cb43-194" aria-hidden="true" tabindex="-1"></a>    transaction_cost_pct<span class="op">=</span><span class="fl">0.001</span>,</span>
<span id="cb43-195"><a href="#cb43-195" aria-hidden="true" tabindex="-1"></a>    holding_period<span class="op">=</span><span class="dv">5</span></span>
<span id="cb43-196"><a href="#cb43-196" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb43-197"><a href="#cb43-197" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb43-198"><a href="#cb43-198" aria-hidden="true" tabindex="-1"></a>    portfolio_values <span class="op">=</span> []</span>
<span id="cb43-199"><a href="#cb43-199" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-200"><a href="#cb43-200" aria-hidden="true" tabindex="-1"></a>    entry_index <span class="op">=</span> <span class="op">-</span>holding_period</span>
<span id="cb43-201"><a href="#cb43-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-202"><a href="#cb43-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(df)):</span>
<span id="cb43-203"><a href="#cb43-203" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> df.iloc[i][signal_col].item()</span>
<span id="cb43-204"><a href="#cb43-204" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> df.iloc[i][<span class="st">&#39;Close&#39;</span>].item()</span>
<span id="cb43-205"><a href="#cb43-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-206"><a href="#cb43-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">-</span> entry_index <span class="op">&gt;=</span> holding_period:</span>
<span id="cb43-207"><a href="#cb43-207" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb43-208"><a href="#cb43-208" aria-hidden="true" tabindex="-1"></a>                cash <span class="op">+=</span> position <span class="op">*</span> price</span>
<span id="cb43-209"><a href="#cb43-209" aria-hidden="true" tabindex="-1"></a>                cash <span class="op">-=</span> <span class="bu">abs</span>(position <span class="op">*</span> price) <span class="op">*</span> transaction_cost_pct</span>
<span id="cb43-210"><a href="#cb43-210" aria-hidden="true" tabindex="-1"></a>                position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-211"><a href="#cb43-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-212"><a href="#cb43-212" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb43-213"><a href="#cb43-213" aria-hidden="true" tabindex="-1"></a>                shares <span class="op">=</span> (cash <span class="op">*</span> max_leverage) <span class="op">//</span> price</span>
<span id="cb43-214"><a href="#cb43-214" aria-hidden="true" tabindex="-1"></a>                cost <span class="op">=</span> shares <span class="op">*</span> price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> transaction_cost_pct)</span>
<span id="cb43-215"><a href="#cb43-215" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> cost <span class="op">&lt;=</span> cash:</span>
<span id="cb43-216"><a href="#cb43-216" aria-hidden="true" tabindex="-1"></a>                    position <span class="op">=</span> shares</span>
<span id="cb43-217"><a href="#cb43-217" aria-hidden="true" tabindex="-1"></a>                    cash <span class="op">-=</span> cost</span>
<span id="cb43-218"><a href="#cb43-218" aria-hidden="true" tabindex="-1"></a>                    entry_index <span class="op">=</span> i</span>
<span id="cb43-219"><a href="#cb43-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-220"><a href="#cb43-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-221"><a href="#cb43-221" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb43-222"><a href="#cb43-222" aria-hidden="true" tabindex="-1"></a>                shares <span class="op">=</span> (cash <span class="op">*</span> max_leverage) <span class="op">//</span> price</span>
<span id="cb43-223"><a href="#cb43-223" aria-hidden="true" tabindex="-1"></a>                proceeds <span class="op">=</span> shares <span class="op">*</span> price <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> transaction_cost_pct)</span>
<span id="cb43-224"><a href="#cb43-224" aria-hidden="true" tabindex="-1"></a>                position <span class="op">=</span> <span class="op">-</span>shares</span>
<span id="cb43-225"><a href="#cb43-225" aria-hidden="true" tabindex="-1"></a>                cash <span class="op">+=</span> proceeds</span>
<span id="cb43-226"><a href="#cb43-226" aria-hidden="true" tabindex="-1"></a>                entry_index <span class="op">=</span> i</span>
<span id="cb43-227"><a href="#cb43-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-228"><a href="#cb43-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-229"><a href="#cb43-229" aria-hidden="true" tabindex="-1"></a>        portfolio_value <span class="op">=</span> cash <span class="op">+</span> position <span class="op">*</span> price</span>
<span id="cb43-230"><a href="#cb43-230" aria-hidden="true" tabindex="-1"></a>        portfolio_values.append(portfolio_value)</span>
<span id="cb43-231"><a href="#cb43-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-232"><a href="#cb43-232" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f&#39;</span><span class="sc">{</span>signal_col<span class="sc">}</span><span class="ss">_Options_Realistic_Portfolio&#39;</span>] <span class="op">=</span> portfolio_values</span>
<span id="cb43-233"><a href="#cb43-233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb43-234"><a href="#cb43-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-235"><a href="#cb43-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-236"><a href="#cb43-236" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">&quot;lstm_model.h5&quot;</span>) <span class="kw">or</span> <span class="kw">not</span> os.path.exists(<span class="st">&quot;rf_model.pkl&quot;</span>):</span>
<span id="cb43-237"><a href="#cb43-237" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> yf.download(<span class="st">&quot;XOM&quot;</span>, start<span class="op">=</span><span class="st">&quot;2010-01-01&quot;</span>, end<span class="op">=</span><span class="st">&quot;2025-01-01&quot;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-238"><a href="#cb43-238" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-239"><a href="#cb43-239" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> engineer_features(df)</span>
<span id="cb43-240"><a href="#cb43-240" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> label_signals(df)</span>
<span id="cb43-241"><a href="#cb43-241" aria-hidden="true" tabindex="-1"></a>    train_lstm_model(df)</span>
<span id="cb43-242"><a href="#cb43-242" aria-hidden="true" tabindex="-1"></a>    train_rf_model(df)</span>
<span id="cb43-243"><a href="#cb43-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-244"><a href="#cb43-244" aria-hidden="true" tabindex="-1"></a>predict_signal_from_yfinance(<span class="st">&quot;XOM&quot;</span>)</span>
<span id="cb43-245"><a href="#cb43-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-246"><a href="#cb43-246" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> yf.download(<span class="st">&quot;XOM&quot;</span>, start<span class="op">=</span><span class="st">&quot;2010-01-01&quot;</span>, end<span class="op">=</span><span class="st">&quot;2025-01-01&quot;</span>, auto_adjust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-247"><a href="#cb43-247" aria-hidden="true" tabindex="-1"></a>df.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-248"><a href="#cb43-248" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> engineer_features(df)</span>
<span id="cb43-249"><a href="#cb43-249" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> label_signals(df)</span>
<span id="cb43-250"><a href="#cb43-250" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_model_predictions(df, model_type<span class="op">=</span><span class="st">&#39;rf&#39;</span>)</span>
<span id="cb43-251"><a href="#cb43-251" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_model_predictions(df, model_type<span class="op">=</span><span class="st">&#39;lstm&#39;</span>)</span>
<span id="cb43-252"><a href="#cb43-252" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_with_options(df, signal_col<span class="op">=</span><span class="st">&#39;Signal&#39;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>1/1 ━━━━━━━━━━━━━━━━━━━━ 1s 1s/step
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
<div class="output stream stdout">
<pre><code>LSTM Prediction: 0, RF Prediction: 0
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
/tmp/ipython-input-3841117184.py:131: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  price = float(df[&#39;Close&#39;].iloc[i])
WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>118/118 ━━━━━━━━━━━━━━━━━━━━ 2s 10ms/step
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/tmp/ipython-input-3841117184.py:131: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  price = float(df[&#39;Close&#39;].iloc[i])
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="57"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="AlPLGogHYWV5" data-outputId="7d3f9c01-4182-41ce-854a-479499c31812">
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_with_options_realistic(df, signal_col<span class="op">=</span><span class="st">&#39;Signal&#39;</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>metrics_options_realistic <span class="op">=</span> calculate_performance_metrics(df, <span class="st">&#39;Signal_Options_Realistic_Portfolio&#39;</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>metrics_rf <span class="op">=</span> calculate_performance_metrics(df, <span class="st">&#39;RF_Portfolio&#39;</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>metrics_lstm <span class="op">=</span> calculate_performance_metrics(df, <span class="st">&#39;LSTM_Portfolio&#39;</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;BuyHold&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">/</span> df[<span class="st">&#39;Close&#39;</span>].iloc[<span class="dv">0</span>] <span class="op">*</span> initial_cash</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>metrics_bh <span class="op">=</span> calculate_performance_metrics(df, <span class="st">&#39;BuyHold&#39;</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Random Forest:</span><span class="ch">\n</span><span class="st">&quot;</span>, metrics_rf)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;LSTM:</span><span class="ch">\n</span><span class="st">&quot;</span>, metrics_lstm)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Options/Short Realistic:</span><span class="ch">\n</span><span class="st">&quot;</span>, metrics_options_realistic)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Buy &amp; Hold:</span><span class="ch">\n</span><span class="st">&quot;</span>, metrics_bh)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Random Forest:
 {&#39;Cumulative Return&#39;: np.float64(38.5285), &#39;Annualized Return&#39;: np.float64(0.2779), &#39;Annualized Volatility&#39;: np.float64(0.1384), &#39;Sharpe Ratio&#39;: np.float64(1.8432), &#39;Max Drawdown&#39;: -0.3378}
LSTM:
 {&#39;Cumulative Return&#39;: np.float64(0.8993), &#39;Annualized Return&#39;: np.float64(-0.0071), &#39;Annualized Volatility&#39;: np.float64(0.0975), &#39;Sharpe Ratio&#39;: np.float64(-0.0242), &#39;Max Drawdown&#39;: -0.3606}
Options/Short Realistic:
 {&#39;Cumulative Return&#39;: np.float64(17355139155.0099), &#39;Annualized Return&#39;: np.float64(3.871), &#39;Annualized Volatility&#39;: np.float64(0.4883), &#39;Sharpe Ratio&#39;: np.float64(3.4897), &#39;Max Drawdown&#39;: -0.3476}
Buy &amp; Hold:
 {&#39;Cumulative Return&#39;: np.float64(2.8282), &#39;Annualized Return&#39;: np.float64(0.0723), &#39;Annualized Volatility&#39;: np.float64(0.2501), &#39;Sharpe Ratio&#39;: np.float64(0.4045), &#39;Max Drawdown&#39;: -0.624}
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="61"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="p5Uqyis_Z7Ff" data-outputId="3ac1af46-7a41-4b0e-e47f-4075d0d55a63">
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_options_decay(df, signal_col<span class="op">=</span><span class="st">&#39;Signal&#39;</span>, initial_cash<span class="op">=</span><span class="dv">10000</span>, max_allocation<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>                           risk_level<span class="op">=</span><span class="st">&#39;medium&#39;</span>, decay_rate<span class="op">=</span><span class="fl">0.9</span>, vola_threshold<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> risk_level <span class="op">==</span> <span class="st">&#39;low&#39;</span>:</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.04</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> risk_level <span class="op">==</span> <span class="st">&#39;high&#39;</span>:</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.01</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        buy_threshold <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        sell_threshold <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> initial_cash</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    premium <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    portfolio_values <span class="op">=</span> []</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> <span class="bu">int</span>(row[signal_col])</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> <span class="bu">float</span>(row[<span class="st">&#39;Close&#39;</span>])</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>        vola <span class="op">=</span> <span class="bu">float</span>(row[<span class="st">&#39;STD_20&#39;</span>])</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vola <span class="op">&lt;</span> vola_threshold:</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>            portfolio_values.append(cash <span class="op">+</span> position <span class="op">*</span> premium)</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> signal <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>((cash <span class="op">*</span> max_allocation) <span class="op">//</span> price)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>            premium <span class="op">=</span> shares <span class="op">*</span> <span class="fl">0.05</span> <span class="op">*</span> price</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> premium</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> price</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">and</span> position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>((cash <span class="op">*</span> max_allocation) <span class="op">//</span> price)</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>            premium <span class="op">=</span> shares <span class="op">*</span> <span class="fl">0.05</span> <span class="op">*</span> price</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> premium</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> price</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> signal <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>            shares <span class="op">=</span> <span class="bu">int</span>(premium <span class="op">/</span> (<span class="fl">0.05</span> <span class="op">*</span> entry_price))</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> position <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>                profit <span class="op">=</span> <span class="bu">max</span>((price <span class="op">-</span> entry_price), <span class="dv">0</span>) <span class="op">*</span> shares</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> position <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>                profit <span class="op">=</span> <span class="bu">max</span>((entry_price <span class="op">-</span> price), <span class="dv">0</span>) <span class="op">*</span> shares</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>                profit <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> profit</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>            premium <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>            position <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>        premium <span class="op">*=</span> decay_rate</span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>        portfolio_values.append(cash <span class="op">+</span> premium)</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f&#39;</span><span class="sc">{</span>signal_col<span class="sc">}</span><span class="ss">_OptionsDecay_Portfolio&#39;</span>] <span class="op">=</span> portfolio_values</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> backtest_options_decay(df, signal_col<span class="op">=</span><span class="st">&#39;Signal&#39;</span>)</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>metrics_options_decay <span class="op">=</span> calculate_performance_metrics(df, <span class="st">&#39;Signal_OptionsDecay_Portfolio&#39;</span>)</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Options/Short Decay:</span><span class="ch">\n</span><span class="st">&quot;</span>, metrics_options_decay)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/tmp/ipython-input-2023172249.py:20: FutureWarning: Calling int on a single element Series is deprecated and will raise a TypeError in the future. Use int(ser.iloc[0]) instead
  signal = int(row[signal_col])
/tmp/ipython-input-2023172249.py:21: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  price = float(row[&#39;Close&#39;])
/tmp/ipython-input-2023172249.py:22: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  vola = float(row[&#39;STD_20&#39;])
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Options/Short Decay:
 {&#39;Cumulative Return&#39;: np.float64(0.0032), &#39;Annualized Return&#39;: np.float64(-0.3203), &#39;Annualized Volatility&#39;: np.float64(0.0811), &#39;Sharpe Ratio&#39;: np.float64(-4.7187), &#39;Max Drawdown&#39;: -0.9968}
</code></pre>
</div>
</div>
</body>
</html>
